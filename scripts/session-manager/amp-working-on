#!/bin/bash
# amp-working-on - Display your active session journal
# Shows what you were working on across all Amplifier sessions

JOURNAL_FILE="$HOME/.amp-session-journal.md"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

# Parse arguments
RAW_MODE=false
BRIEF_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --raw|-r)
            RAW_MODE=true
            shift
            ;;
        --brief|-b)
            BRIEF_MODE=true
            shift
            ;;
        --help|-h)
            echo "Usage: amp-working-on [OPTIONS]"
            echo ""
            echo "Display your active Amplifier session journal."
            echo ""
            echo "Options:"
            echo "  -b, --brief    Show just session names and directories"
            echo "  -r, --raw      Output raw markdown (for piping)"
            echo "  -h, --help     Show this help message"
            echo ""
            echo "The journal is generated by amp-save-sessions."
            echo "Run amp-save-sessions first to capture your current sessions."
            exit 0
            ;;
        *)
            echo "Unknown option: $1 (use --help)"
            exit 1
            ;;
    esac
done

if [[ ! -f "$JOURNAL_FILE" ]]; then
    echo -e "${YELLOW}No session journal found.${NC}"
    echo "Run ${GREEN}amp-save-sessions${NC} first to capture your active sessions."
    exit 1
fi

# Check staleness
journal_mod=$(stat -c %Y "$JOURNAL_FILE" 2>/dev/null)
now=$(date +%s)
age=$((now - journal_mod))

if $RAW_MODE; then
    cat "$JOURNAL_FILE"
    exit 0
fi

if $BRIEF_MODE; then
    echo -e "${BLUE}${BOLD}Active Sessions${NC}"
    # Extract just the session headers with directory
    grep -E "^### |^\- \*\*Directory\*\*|^\- \*\*Last active\*\*" "$JOURNAL_FILE" | while IFS= read -r line; do
        if [[ "$line" == "### "* ]]; then
            name="${line#"### "}"
            echo -e "\n  ${GREEN}â—${NC} ${BOLD}$name${NC}"
        elif [[ "$line" == *"Directory"* ]]; then
            dir=$(echo "$line" | sed 's/.*`\(.*\)`.*/\1/')
            echo -e "    ${DIM}$dir${NC}"
        elif [[ "$line" == *"Last active"* ]]; then
            active=$(echo "$line" | sed 's/.*\*\*: //')
            echo -e "    ${DIM}$active${NC}"
        fi
    done
    echo ""
    if [[ $age -gt 3600 ]]; then
        echo -e "${DIM}Journal is $((age / 3600))h old. Run amp-save-sessions to refresh.${NC}"
    fi
    exit 0
fi

# Full display with staleness warning
if [[ $age -gt 3600 ]]; then
    hours=$((age / 3600))
    echo -e "${YELLOW}Note: Journal is ${hours}h old. Run ${GREEN}amp-save-sessions${NC}${YELLOW} to refresh.${NC}"
    echo ""
fi

# Pretty-print the markdown (use glow if available, otherwise cat with basic formatting)
if command -v glow &>/dev/null; then
    glow -w 100 "$JOURNAL_FILE"
else
    cat "$JOURNAL_FILE"
fi
