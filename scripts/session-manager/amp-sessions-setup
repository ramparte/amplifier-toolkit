#!/bin/bash
# amp-sessions-setup - Install bashrc snippet for automatic terminal resumption

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}Amplifier Session Restore Setup${NC}"
echo ""
echo "This will add a snippet to ~/.bashrc that automatically runs"
echo "'amplifier resume' when VS Code terminals are opened during restore."
echo ""

# Check if already installed
if grep -q "amp-restore-triggers.json" ~/.bashrc 2>/dev/null; then
    echo -e "${YELLOW}The bashrc snippet appears to already be installed.${NC}"
    echo ""
    echo -e "Found in ~/.bashrc at line: $(grep -n "amp-restore-triggers.json" ~/.bashrc | head -1 | cut -d: -f1)"
    echo ""
    read -p "Reinstall anyway? (y/N): " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    echo ""
fi

# Backup bashrc
echo -e "${BLUE}Creating backup...${NC}"
cp ~/.bashrc ~/.bashrc.backup-$(date +%Y%m%d-%H%M%S)
echo -e "${GREEN}✓${NC} Backed up to ~/.bashrc.backup-$(date +%Y%m%d-%H%M%S)"

# Add the snippet
echo -e "${BLUE}Adding snippet to ~/.bashrc...${NC}"

cat >> ~/.bashrc << 'BASHRC_EOF'

# Amplifier session restore - auto-run commands in new terminals
if [[ -f /tmp/.amp-restore-triggers.json ]] && [[ -n "$VSCODE_INJECTION" ]]; then
    trigger_file="/tmp/.amp-restore-triggers.json"
    cwd="$(pwd)"
    
    # Check if there's a command for this directory
    cmd=$(jq -r --arg dir "$cwd" 'if .[$dir] and (.[$dir] | length) > 0 then .[$dir][0] else "" end' "$trigger_file" 2>/dev/null)
    
    if [[ -n "$cmd" ]]; then
        # Remove the command from the queue (consume it)
        jq --arg dir "$cwd" 'if .[$dir] and (.[$dir] | length) > 0 then .[$dir] = .[$dir][1:] else . end' "$trigger_file" > "$trigger_file.tmp" && mv "$trigger_file.tmp" "$trigger_file"
        
        # Execute the command
        eval "$cmd"
    fi
fi
BASHRC_EOF

echo -e "${GREEN}✓${NC} Added to ~/.bashrc"
echo ""
echo -e "${GREEN}Setup complete!${NC}"
echo ""
echo "The snippet will activate in newly opened VS Code terminals."
echo "To test immediately, run: ${BLUE}source ~/.bashrc${NC}"
echo ""
echo "Now try:"
echo "  1. ${BLUE}amp-save-sessions${NC} - Save your current sessions"
echo "  2. Close all VS Code windows"
echo "  3. ${BLUE}amp-restore-sessions${NC} - Restore and watch them auto-run!"
