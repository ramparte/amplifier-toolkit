#!/bin/bash
# amp-restore-sessions - Restore previously saved Amplifier sessions
# Opens VS Code windows with integrated WSL terminals running amplifier resume
# Supports multiple sessions per directory (multiple terminals in same window)

set -e

# Store outside of ~/.amplifier to survive amplifier reset/cache clearing
HISTORY_FILE="$HOME/.amp-session-history.json"
TRIGGER_FILE="/tmp/.amp-restore-triggers.json"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Auto-detect WSL distribution name
WSL_DISTRO=$(wsl.exe -l -q 2>/dev/null | head -1 | tr -d '\0\r' || echo "Ubuntu")

# Parse arguments
DRY_RUN=false
LIST_MODE=false
SELECTED_ID=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run|-n)
            DRY_RUN=true
            shift
            ;;
        --list|-l)
            LIST_MODE=true
            shift
            ;;
        --id)
            SELECTED_ID="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: amp-restore-sessions [OPTIONS]"
            echo ""
            echo "Restore previously saved Amplifier sessions in VS Code."
            echo ""
            echo "Options:"
            echo "  -l, --list       List all saved session groups and pick one"
            echo "  --id <N>         Restore a specific save by ID"
            echo "  -n, --dry-run    Show what would be done without executing"
            echo "  -h, --help       Show this help message"
            echo ""
            echo "By default, restores the most recent save."
            echo ""
            echo "Each session opens in a VS Code window with an integrated"
            echo "WSL terminal running 'amplifier resume <session_id>'."
            echo ""
            echo "Multiple sessions in the same directory open multiple terminals"
            echo "in the same VS Code window."
            echo ""
            echo "SETUP REQUIRED: Add the bashrc snippet from README.md"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use --help for usage information."
            exit 1
            ;;
    esac
done

# Check if history file exists
if [[ ! -f "$HISTORY_FILE" ]]; then
    echo -e "${RED}No session history found.${NC}"
    echo "Run 'amp-save-sessions' first to save your current sessions."
    exit 1
fi

# Read history
history=$(cat "$HISTORY_FILE")
save_count=$(echo "$history" | jq '.saves | length')

if [[ "$save_count" -eq 0 ]]; then
    echo -e "${YELLOW}No saves in history.${NC}"
    exit 0
fi

# Function to display a save entry
display_save() {
    local save="$1"
    local id=$(echo "$save" | jq -r '.id')
    local saved_at=$(echo "$save" | jq -r '.saved_at')
    local session_count=$(echo "$save" | jq '.sessions | length')
    local dir_count=$(echo "$save" | jq '[.sessions[].directory] | unique | length')
    
    local formatted_date=$(date -d "$saved_at" "+%Y-%m-%d %H:%M" 2>/dev/null || echo "$saved_at")
    
    echo -e "  ${CYAN}#${id}${NC} - ${formatted_date} (${session_count} session(s) in ${dir_count} window(s))"
    
    # Group by directory for display
    echo "$save" | jq -r '.sessions | group_by(.directory) | .[] | 
        "      \(.[0].directory): \(length) terminal(s)"'
}

# List mode: show all saves and let user pick
if $LIST_MODE; then
    echo -e "${BLUE}${BOLD}Saved Session Groups:${NC}"
    echo ""
    
    echo "$history" | jq -c '.saves | reverse | .[]' | while read -r save; do
        display_save "$save"
        echo ""
    done
    
    echo -e "${BLUE}Enter save ID to restore (or 'q' to quit):${NC} "
    read -r choice
    
    if [[ "$choice" == "q" ]] || [[ -z "$choice" ]]; then
        echo "Cancelled."
        exit 0
    fi
    
    SELECTED_ID="$choice"
fi

# Determine which save to restore
if [[ -n "$SELECTED_ID" ]]; then
    selected_save=$(echo "$history" | jq --arg id "$SELECTED_ID" '.saves[] | select(.id == ($id | tonumber))')
    if [[ -z "$selected_save" ]]; then
        echo -e "${RED}Save #${SELECTED_ID} not found.${NC}"
        echo "Use --list to see available saves."
        exit 1
    fi
else
    selected_save=$(echo "$history" | jq '.saves | last')
fi

# Extract save details
save_id=$(echo "$selected_save" | jq -r '.id')
saved_at=$(echo "$selected_save" | jq -r '.saved_at')
session_count=$(echo "$selected_save" | jq '.sessions | length')
dir_count=$(echo "$selected_save" | jq '[.sessions[].directory] | unique | length')

echo -e "${BLUE}Restoring save #${save_id} from ${saved_at}${NC}"
echo -e "${BLUE}(${session_count} session(s) in ${dir_count} VS Code window(s))${NC}"
echo ""

if $DRY_RUN; then
    echo "$selected_save" | jq -r '.sessions | group_by(.directory) | .[] | 
        "  → \(.[0].directory): \(length) terminal(s)\n" + 
        (reduce .[] as $s (""; . + "      Session: \($s.session_id)\n"))'
    echo ""
    echo -e "${YELLOW}Dry run - no sessions were restored.${NC}"
    exit 0
fi

# Build trigger file - this time with ARRAY of commands per directory
# Each terminal that opens will pop the first command from its directory's array
triggers="{}"
while IFS= read -r session; do
    session_id=$(echo "$session" | jq -r '.session_id')
    directory=$(echo "$session" | jq -r '.directory')
    
    if [[ "$session_id" == "UNKNOWN" ]]; then
        cmd="amplifier resume"
    else
        cmd="amplifier resume '$session_id'"
    fi
    
    # Add command to array for this directory
    triggers=$(echo "$triggers" | jq --arg dir "$directory" --arg cmd "$cmd" '
        if .[$dir] then
            .[$dir] += [$cmd]
        else
            .[$dir] = [$cmd]
        end
    ')
done < <(echo "$selected_save" | jq -c '.sessions[]')

# Write trigger file
echo "$triggers" > "$TRIGGER_FILE"
chmod 644 "$TRIGGER_FILE"

# Group sessions by directory
directories=$(echo "$selected_save" | jq -r '[.sessions[].directory] | unique | .[]')

for directory in $directories; do
    # Count sessions for this directory
    term_count=$(echo "$selected_save" | jq --arg dir "$directory" '[.sessions[] | select(.directory == $dir)] | length')
    
    echo -e "  ${GREEN}→${NC} $directory (${term_count} terminal(s))"
    
    # Show session IDs
    echo "$selected_save" | jq -r --arg dir "$directory" '
        .sessions[] | select(.directory == $dir) | 
        "      Session: \(.session_id)"'
    
    # Open VS Code window
    code --new-window --remote "wsl+$WSL_DISTRO" "$directory" &
    sleep 2
    
    # Open terminals - one for each session in this directory
    for ((i=0; i<term_count; i++)); do
        code --remote "wsl+$WSL_DISTRO" "$directory" --command "workbench.action.terminal.new"
        sleep 0.8
    done
    
    # Delay before next window
    sleep 1
done

echo ""
echo -e "${GREEN}VS Code windows opened with terminals!${NC}"
echo ""
echo -e "${BLUE}Note:${NC} If terminals didn't auto-run, add the bashrc snippet from README.md"
