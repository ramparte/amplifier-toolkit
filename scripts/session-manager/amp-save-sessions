#!/bin/bash
# amp-save-sessions - Save Amplifier sessions from open VS Code WSL terminals
# Finds VS Code terminal windows and looks up their most recent amplifier sessions
# Appends session snapshots to ~/.amplifier/session-history.json with numbered entries

set -e

HISTORY_FILE="$HOME/.amplifier/session-history.json"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${BLUE}Scanning for VS Code WSL terminals with Amplifier sessions...${NC}"

# Find VS Code terminal bash shells by looking for the shellIntegration init file
# This finds all open VS Code terminal windows, regardless of whether amplifier is running
declare -A seen_dirs  # Track unique directories
sessions=()

while IFS= read -r pid; do
    [[ -z "$pid" ]] && continue
    
    # Get the working directory
    cwd=$(readlink "/proc/$pid/cwd" 2>/dev/null) || continue
    
    # Skip if we've already processed this directory
    [[ -n "${seen_dirs[$cwd]}" ]] && continue
    seen_dirs[$cwd]=1
    
    # Convert cwd to project path format (replace / with -)
    project_path=$(echo "$cwd" | sed 's|^/||; s|/|-|g; s|^|-|')
    project_dir="$HOME/.amplifier/projects/$project_path/sessions"
    
    # Skip if no sessions directory for this project
    [[ ! -d "$project_dir" ]] && continue
    
    # Find the most recent root session (UUID only, not sub-agent sessions with underscores)
    # Root sessions are 36-char UUIDs, sub-sessions have _suffix
    session_id=""
    latest_time=0
    
    for session_dir in "$project_dir"/*/; do
        [[ ! -d "$session_dir" ]] && continue
        
        # Get just the directory name
        dir_name=$(basename "$session_dir")
        
        # Skip sub-agent sessions (they contain underscore after UUID)
        # Root sessions are exactly 36 chars (UUID format: 8-4-4-4-12)
        if [[ ${#dir_name} -eq 36 ]] && [[ "$dir_name" =~ ^[0-9a-f-]+$ ]]; then
            # Get modification time
            mod_time=$(stat -c %Y "$session_dir" 2>/dev/null) || continue
            
            if [[ $mod_time -gt $latest_time ]]; then
                latest_time=$mod_time
                session_id="$dir_name"
            fi
        fi
    done
    
    # Only save if we found a session
    if [[ -n "$session_id" ]]; then
        sessions+=("{\"session_id\": \"$session_id\", \"directory\": \"$cwd\", \"terminal_pid\": $pid}")
        echo -e "  ${CYAN}Found:${NC} $cwd"
    fi
done < <(pgrep -f 'shellIntegration-bash' 2>/dev/null)

# Check if we found any sessions
if [[ ${#sessions[@]} -eq 0 ]]; then
    echo -e "${YELLOW}No VS Code terminals with Amplifier sessions found.${NC}"
    echo ""
    echo "Tips:"
    echo "  - Make sure you have VS Code WSL terminals open"
    echo "  - The terminal's working directory must have had an amplifier session"
    exit 0
fi

# Build JSON array of sessions
json_sessions=$(printf '%s\n' "${sessions[@]}" | jq -s '.')

# Get current timestamp
timestamp=$(date -Iseconds)

# Initialize history file if it doesn't exist
if [[ ! -f "$HISTORY_FILE" ]]; then
    echo '{"saves": [], "next_id": 1}' > "$HISTORY_FILE"
fi

# Read current history and get next ID
current_history=$(cat "$HISTORY_FILE")
next_id=$(echo "$current_history" | jq -r '.next_id')

# Create the new save entry
new_entry=$(jq -n \
    --arg id "$next_id" \
    --arg ts "$timestamp" \
    --argjson sessions "$json_sessions" \
    '{id: ($id | tonumber), saved_at: $ts, sessions: $sessions}')

# Append to history and increment next_id
updated_history=$(echo "$current_history" | jq \
    --argjson entry "$new_entry" \
    '.saves += [$entry] | .next_id += 1')

# Save updated history
echo "$updated_history" > "$HISTORY_FILE"

# Display results
echo ""
echo -e "${GREEN}Saved ${#sessions[@]} session(s) as save #${next_id}${NC}"
echo ""
echo "$json_sessions" | jq -r '.[] | "  \(.directory) -> \(.session_id)"'
echo ""
echo -e "${BLUE}History now contains $(echo "$updated_history" | jq '.saves | length') save(s)${NC}"
echo -e "To restore, run: ${GREEN}amp-restore-sessions${NC} (latest) or ${GREEN}amp-restore-sessions --list${NC} (pick one)"
